# Data Model: Workbench Custom Image Introspection Testing

**Feature**: Workbench Custom Image Introspection Testing
**Date**: 2025-10-30

## Overview

This document defines the key entities, their relationships, and state transitions for the custom workbench image validation feature. Since this is a test framework extension (not production code), the "data model" represents test configuration, runtime state, and validation results.

---

## Entity 1: CustomImageTestConfiguration

**Purpose**: Encapsulates parametrization data for a single custom image validation test case.

### Fields

| Field | Type | Required | Description | Validation Rules |
|-------|------|----------|-------------|------------------|
| `namespace` | `str` | Yes | Kubernetes namespace for test resources | Must match pattern `test-*` |
| `notebook_name` | `str` | Yes | Name of the Notebook CR to create | Alphanumeric + hyphens, max 63 chars |
| `custom_image` | `str` | Yes | Full container image URL with tag | Must include registry, repository, and tag |
| `packages_to_verify` | `list[str]` | Yes | Python package names to verify importability | Non-empty list of valid Python identifiers |
| `timeout_pod_ready` | `int` | No | Timeout in seconds for pod readiness (default: 600) | Range: 60-900 seconds |
| `timeout_command` | `int` | No | Timeout in seconds for command execution (default: 60) | Range: 10-300 seconds |
| `auth_annotations` | `dict[str, str]` | No | Optional auth sidecar resource annotations | Key-value pairs for kube-rbac-proxy config |

### Example

```python
config = CustomImageTestConfiguration(
    namespace="test-sdg-hub",
    notebook_name="sdg-hub-notebook",
    custom_image="quay.io/opendatahub/sdg-hub-notebook:2025.1",
    packages_to_verify=["sdg_hub", "instructlab"],
    timeout_pod_ready=600,
    timeout_command=60,
    auth_annotations={}
)
```

### Relationships
- **Creates** → `NotebookResource` (via pytest fixture)
- **Produces** → `PackageVerificationResult` (via test execution)

---

## Entity 2: NotebookResource

**Purpose**: Represents a Kubernetes Notebook custom resource created by the test fixture.

### Fields

| Field | Type | Required | Description | Derived From |
|-------|------|----------|-------------|--------------|
| `name` | `str` | Yes | Notebook CR name | `CustomImageTestConfiguration.notebook_name` |
| `namespace` | `str` | Yes | Namespace where notebook is created | `CustomImageTestConfiguration.namespace` |
| `image` | `str` | Yes | Container image used for workbench | `CustomImageTestConfiguration.custom_image` |
| `pod_name` | `str` | Yes | Generated pod name (name + "-0") | Auto-generated by notebook controller |
| `container_name` | `str` | Yes | Main container name in pod | Matches `name` field |
| `status` | `NotebookStatus` | Yes | Current notebook status | Runtime state |

### State Machine: NotebookStatus

```
Created → PodPending → PodRunning → Ready → (Deleted)
                ↓
            Failed (ImagePullBackOff, CrashLoopBackOff)
```

**States**:
- `Created`: Notebook CR created, waiting for pod
- `PodPending`: Pod exists but not yet running
- `PodRunning`: Pod running, waiting for Ready condition
- `Ready`: Pod ready, can execute commands
- `Failed`: Pod failed to reach running/ready state

**Transitions**:
- `Created → PodPending`: Pod appears in namespace
- `PodPending → PodRunning`: All containers start
- `PodRunning → Ready`: Readiness probe succeeds
- `PodPending/PodRunning → Failed`: Image pull fails, container crashes

### Example

```python
notebook = NotebookResource(
    name="sdg-hub-notebook",
    namespace="test-sdg-hub",
    image="quay.io/opendatahub/sdg-hub-notebook:2025.1",
    pod_name="sdg-hub-notebook-0",
    container_name="sdg-hub-notebook",
    status=NotebookStatus.Ready
)
```

### Relationships
- **Created by** → `CustomImageTestConfiguration`
- **Validated by** → `PackageVerificationResult`

---

## Entity 3: PackageVerificationResult

**Purpose**: Represents the outcome of package import verification for a single package in a container.

### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `package_name` | `str` | Yes | Python package name that was tested |
| `import_successful` | `bool` | Yes | Whether import succeeded |
| `error_message` | `str | None` | No | Error message if import failed |
| `command_executed` | `str` | Yes | Exact command that was run |
| `execution_time_seconds` | `float` | Yes | Time taken to execute command |
| `pod_logs` | `str | None` | No | Pod logs captured on failure |

### Validation Rules
- `import_successful=False` MUST have non-null `error_message`
- `import_successful=True` SHOULD have null `error_message`
- `execution_time_seconds` MUST be less than configured timeout
- `command_executed` MUST match pattern `python -c "import {package_name}"`

### Example: Success Case

```python
result = PackageVerificationResult(
    package_name="sdg_hub",
    import_successful=True,
    error_message=None,
    command_executed="python -c 'import sdg_hub'",
    execution_time_seconds=0.8,
    pod_logs=None
)
```

### Example: Failure Case

```python
result = PackageVerificationResult(
    package_name="missing_package",
    import_successful=False,
    error_message="ModuleNotFoundError: No module named 'missing_package'",
    command_executed="python -c 'import missing_package'",
    execution_time_seconds=1.2,
    pod_logs="Traceback (most recent call last):\n  File \"<string>\", line 1...\n"
)
```

### Relationships
- **Validates** → `NotebookResource`
- **Produced by** → `CustomImageTestConfiguration`

---

## Entity 4: PodDiagnosticInfo

**Purpose**: Diagnostic information collected when pod fails to reach ready state.

### Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `pod_name` | `str` | Yes | Name of the failed pod |
| `pod_phase` | `str` | Yes | Kubernetes pod phase (Pending, Failed, etc.) |
| `container_statuses` | `list[ContainerStatus]` | Yes | Status of each container |
| `error_category` | `PodFailureCategory` | Yes | Categorized failure reason |
| `logs` | `dict[str, str]` | Yes | Container name → log output mapping |
| `events` | `list[str]` | No | Pod events (future enhancement) |

### PodFailureCategory (Enum)

```python
class PodFailureCategory(str, Enum):
    IMAGE_PULL_ERROR = "ImagePullBackOff"
    CRASH_LOOP = "CrashLoopBackOff"
    INVALID_IMAGE = "InvalidImageName"
    TIMEOUT = "TimeoutWaitingForReady"
    RESOURCE_CONSTRAINTS = "InsufficientResources"
    UNKNOWN = "Unknown"
```

### ContainerStatus (Nested)

| Field | Type | Description |
|-------|------|-------------|
| `name` | `str` | Container name |
| `ready` | `bool` | Container ready status |
| `state` | `str` | waiting/running/terminated |
| `state_reason` | `str | None` | Reason for current state (e.g., "CrashLoopBackOff") |

### Example

```python
diagnostic = PodDiagnosticInfo(
    pod_name="sdg-hub-notebook-0",
    pod_phase="Pending",
    container_statuses=[
        ContainerStatus(
            name="sdg-hub-notebook",
            ready=False,
            state="waiting",
            state_reason="ImagePullBackOff"
        ),
        ContainerStatus(
            name="kube-rbac-proxy",
            ready=False,
            state="waiting",
            state_reason="PodInitializing"
        )
    ],
    error_category=PodFailureCategory.IMAGE_PULL_ERROR,
    logs={
        "sdg-hub-notebook": "Failed to pull image \"quay.io/opendatahub/sdg-hub-notebook:2025.1\": rpc error: code = Unknown desc = error reading manifest...",
        "kube-rbac-proxy": ""
    },
    events=[]
)
```

### Relationships
- **Diagnoses** → `NotebookResource` (when state = Failed)

---

## Entity Relationships Diagram

```
CustomImageTestConfiguration
    |
    | creates (via fixture)
    ↓
NotebookResource ────────────────→ PodDiagnosticInfo
    |                                (if Failed state)
    | validated by
    ↓
PackageVerificationResult
    (one per package)
```

---

## Validation Flow

```
1. CustomImageTestConfiguration
   ↓ (pytest parametrization)
2. Fixture creates NotebookResource
   ↓ (notebook controller creates pod)
3. Wait for NotebookResource.status = Ready
   ├─→ Success: Continue to step 4
   └─→ Failure: Collect PodDiagnosticInfo, raise error
4. For each package in packages_to_verify:
     Execute verification → PackageVerificationResult
5. Assert all PackageVerificationResult.import_successful = True
```

---

## Test Parametrization Mapping

### From Test Parameters to Entities

**pytest.param input**:
```python
pytest.param(
    {"name": "test-sdg-hub", "add-dashboard-label": True},  # Namespace
    {"name": "test-sdg-hub"},                               # PVC
    {
        "namespace": "test-sdg-hub",
        "name": "test-sdg-hub",
        "custom_image": "quay.io/opendatahub/sdg-hub:2025.1",
    },
    id="sdg_hub_image"
)
```

**Maps to**:
1. `CustomImageTestConfiguration` (parsed from third dict)
2. → Fixture creates `NotebookResource`
3. → Test produces `PackageVerificationResult`

---

## Error Propagation

### Failure Scenarios & Data Flow

| Scenario | Detection Point | Data Captured | Exception Raised |
|----------|----------------|---------------|------------------|
| Image pull fails | Pod waiting state | `PodDiagnosticInfo` | `ImagePullError` |
| Container crashes | Pod container status | `PodDiagnosticInfo` + logs | `ContainerCrashError` |
| Pod timeout | `wait_for_condition()` | `PodDiagnosticInfo` | `PodReadinessTimeout` |
| Package missing | `pod.execute()` | `PackageVerificationResult` | `ExecOnPodError` → caught → assertion |
| Command timeout | `pod.execute()` timeout | `PackageVerificationResult` | `CommandTimeoutError` |

---

## Future Enhancements (Out of MVP Scope)

### Additional Fields (Deferred)

**CustomImageTestConfiguration**:
- `notebook_cells`: List of notebook cells to execute (User Story edge case - future)
- `gpu_required`: Boolean flag for GPU workbench images

**PodDiagnosticInfo**:
- `events`: Kubernetes events for troubleshooting
- `resource_usage`: CPU/memory metrics

**PackageVerificationResult**:
- `installed_packages`: Full list of packages in environment (for comparison)
- `version`: Verified package version

---

## Implementation Notes

### Storage
- No persistent storage required
- Entities exist in test runtime memory only
- Diagnostic info logged to test output / must-gather artifacts

### Type Hints
All entities should use Python 3.13 type hints:
```python
from dataclasses import dataclass
from enum import Enum

@dataclass
class PackageVerificationResult:
    package_name: str
    import_successful: bool
    error_message: str | None
    command_executed: str
    execution_time_seconds: float
    pod_logs: str | None
```

### Validation Libraries
Consider using `pydantic` for runtime validation if complexity increases beyond MVP scope.
